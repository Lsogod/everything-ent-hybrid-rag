x-app-build: &app-build
  context: .
  args:
    PYTHON_IMAGE: ${PYTHON_IMAGE:-python:3.10-slim}
    PIP_INDEX_URL: ${PIP_INDEX_URL:-https://pypi.tuna.tsinghua.edu.cn/simple}
    PIP_TRUSTED_HOST: ${PIP_TRUSTED_HOST:-pypi.tuna.tsinghua.edu.cn}

services:

  redis:
    image: redis:7.2-alpine
    container_name: ent_redis
    ports:
      - "6379:6379"

  elasticsearch:
    image: ent_es_ik:${IK_VERSION:-8.11.3}
    build:
      context: .
      dockerfile: docker/es/Dockerfile
      args:
        ES_IMAGE: ${ES_IMAGE:-docker.io/library/elasticsearch:8.11.3}
        IK_VERSION: ${IK_VERSION:-8.11.3}
    container_name: ent_es
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms1g -Xmx1g
    ports:
      - "9200:9200"
    volumes:
      - es_data:/usr/share/elasticsearch/data

  api:
    build: *app-build
    container_name: ent_api
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - HF_ENDPOINT=${HF_ENDPOINT:-https://hf-mirror.com}
      - HF_HUB_DISABLE_XET=${HF_HUB_DISABLE_XET:-1}
      - HF_HOME=/data/hf-cache
      - HUGGINGFACE_HUB_CACHE=/data/hf-cache
      - TRANSFORMERS_CACHE=/data/hf-cache
      - SENTENCE_TRANSFORMERS_HOME=/data/hf-cache
    command: gunicorn -k uvicorn.workers.UvicornWorker -w 2 -b 0.0.0.0:8000 app.main:app
    ports:
      - "${API_PORT:-18000}:8000"
    volumes:
      - ./:/app
      - ./data/knowledge:/data/knowledge
      - ./data/hf-cache:/data/hf-cache
    depends_on:
      - redis
      - elasticsearch

  worker:
    build: *app-build
    container_name: ent_worker
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - HF_ENDPOINT=${HF_ENDPOINT:-https://hf-mirror.com}
      - HF_HUB_DISABLE_XET=${HF_HUB_DISABLE_XET:-1}
      - HF_HOME=/data/hf-cache
      - HUGGINGFACE_HUB_CACHE=/data/hf-cache
      - TRANSFORMERS_CACHE=/data/hf-cache
      - SENTENCE_TRANSFORMERS_HOME=/data/hf-cache
    command: celery -A worker.celery_app.celery_app worker -l info
    volumes:
      - ./:/app
      - ./data/knowledge:/data/knowledge
      - ./data/hf-cache:/data/hf-cache
    depends_on:
      - redis
      - elasticsearch

  watcher:
    build: *app-build
    container_name: ent_watcher
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - HF_ENDPOINT=${HF_ENDPOINT:-https://hf-mirror.com}
      - HF_HUB_DISABLE_XET=${HF_HUB_DISABLE_XET:-1}
      - HF_HOME=/data/hf-cache
      - HUGGINGFACE_HUB_CACHE=/data/hf-cache
      - TRANSFORMERS_CACHE=/data/hf-cache
      - SENTENCE_TRANSFORMERS_HOME=/data/hf-cache
    command: python -m scripts.start_watcher
    volumes:
      - ./:/app
      - ./data/knowledge:/data/knowledge
      - ./data/hf-cache:/data/hf-cache
    depends_on:
      - worker

  frontend:
    image: rag-frontend:latest
    build:
      context: ./frontend
      args:
        FRONTEND_NODE_IMAGE: ${FRONTEND_NODE_IMAGE:-swr.cn-north-4.myhuaweicloud.com/ddn-k8s/docker.io/library/node:22-alpine}
        NPM_REGISTRY: ${NPM_REGISTRY:-https://registry.npmmirror.com}
    container_name: ent_frontend
    ports:
      - "${FRONTEND_PORT:-5173}:80"
    depends_on:
      - api

  eval:
    build:
      context: .
      dockerfile: eval/Dockerfile
      args:
        PYTHON_IMAGE: ${PYTHON_IMAGE:-python:3.10-slim}
        PIP_INDEX_URL: ${PIP_INDEX_URL:-https://pypi.tuna.tsinghua.edu.cn/simple}
        PIP_TRUSTED_HOST: ${PIP_TRUSTED_HOST:-pypi.tuna.tsinghua.edu.cn}
    container_name: ent_eval
    env_file:
      - .env
    environment:
      - PYTHONPATH=/app
      - HF_ENDPOINT=${HF_ENDPOINT:-https://hf-mirror.com}
      - HF_HUB_DISABLE_XET=${HF_HUB_DISABLE_XET:-1}
      - HF_HOME=/data/hf-cache
      - HUGGINGFACE_HUB_CACHE=/data/hf-cache
      - TRANSFORMERS_CACHE=/data/hf-cache
      - SENTENCE_TRANSFORMERS_HOME=/data/hf-cache
    command: python eval/run_duretrieval_baseline.py --method bm25 --top-k 10 --ks 1,3,5,10
    volumes:
      - ./:/app
      - ./data/hf-cache:/data/hf-cache
    profiles:
      - eval

volumes:
  es_data:
